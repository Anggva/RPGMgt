<!DOCTYPE html>
<html>
	<head>
		<title>RPG Campaign Management System</title>
		<link rel='stylesheet' type='text/css' href='style.css'>
		<link rel='stylesheet' type='text/css' href='build/perfect-scrollbar.css'>
		<link href='http://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="http://code.jquery.com/ui/1.11.0/jquery-ui.min.js"></script>
		<script src="build/perfect-scrollbar.js"></script>
		<script src='build/JSXTransformer.js'></script>	
		<script src='build/react.js'></script>
		<script type='text/jsx'>

function start() {
	$.getJSON("mapData.json", function(data) {
		if (!data || data.Success === false) {
			window.alert('Error loading map data. Please refresh the page and try again.');
		} else {
			React.render(<World rootMap={data} />, document.body);
		}
	});
}

function MapNode(parent) {
	this.parentMap = parent;
}

var MapImage = React.createClass({
	getInitialState: function() {
		return {
			zoomFactor : 1.0
		}
	},
	componentDidMount: function() {
		//var mapImageElement = document.getElementById('mapImage');
		//mapImageElement.addEventListener('dblclick', resetImage);
		var wDif = $('#mapImageContainer').width() - $('#mapImage').width();
		var hDif = $('#mapImageContainer').height() - $('#mapImage').height();
		if(wDif > 0 || hDif > 0) {
			if(hDif > wDif) {
				$('#mapImage').css('height','100%');
			} else {
				$('#mapImage').css('width','100%');
			}
		}
		Ps.initialize(document.getElementById('mapImageContainer'), {
			//See https://github.com/noraesae/perfect-scrollbar for info on how to use this.
		});
		var curDown, curYPos, curXPos;
		$('#mapImageContainer').mousemove(function(e){
			if(curDown === true){
				console.log('Scrolling');
				$('#mapImageContainer').scrollTop(
					$('#mapImageContainer').scrollTop() + (curYPos - e.pageY)
				); 
				$('#mapImageContainer').scrollLeft(
					$('#mapImageContainer').scrollLeft() + (curXPos - e.pageX)
				);
			}
		});
		$('#mapImageContainer').mousedown(function(e){
			if(e.which == 2) {
				curDown = true;
				curYPos = e.pageY;
				curXPos = e.pageX;
			}
		});
		$('#mapImageContainer').mouseup(function(){
			curDown = false;
		});
	},
	render: function() {
		return(
			<img id='mapImage' src={this.props.mapNode.imageSrc}>
				{this.props.mapNode.childMaps.map(function(childMap){
					return <div className='mapLoc' onclick='gotoLoc(childMap)' style={childMap.loc} />;
				})}
			</img>
		);
	}
});

var DefaultSidebar = React.createClass({
	getInitialState: function() {
		return {
			infoPaneContents : <p />
		}
	},
	onDesClick: function() {
		this.setState({
			infoPaneContents : <p>{this.props.mapNode.mapInfo}</p>
		})
	},
	onLocClick: function() {
		this.setState({
			infoPaneContents : this.props.mapNode.childMaps.map(function(childMap){
				return <p>{childMap.mapName}</p>;
			})
		})
	},
	onNpcClick: function() {
		this.setState({
			infoPaneContents : this.props.mapNode.npcList.map(function(npc){
				return <p>{npc}</p>;
			})
		})
	},
	render: function() {
		return (
			<div className='container' id='sidebar'>
				<div id='title'><div id='t'>
					<h1>{this.props.mapNode.mapName}</h1>
				</div></div>
				<div id='infoPane'>
					{this.state.infoPaneContents}
				</div>
				<div id="mapDesButton">
					<button type="button" onClick={this.onDesClick}>Description</button>
				</div>
				<div id="locationButton">
					<button type="button" onClick={this.onLocClick}>Location</button>
				</div>
				<div id="npcButton">
					<button type="button" onClick={this.onNpcClick}>NPC</button>
				</div>
				<div id='options'>
				</div>
				<div id='bottomBar'>
					<button onClick={this.props.parent.addNewLoc}>+</button>
					<button onClick={this.props.parent.editMap}>Edit</button>
				</div>
			</div>
		);
	}
});

var EditSidebar = React.createClass({
	getInitialState: function() {
		return {
			Name: 'Name Here',
			Description: 'Description Here',
			NPC: 'NPC Here'
		}
	},
	finishEditing: function() {
		this.props.mapToEdit.mapName = 
			document.getElementById("NameTextbox").value;
		this.props.mapToEdit.mapInfo =
			document.getElementById("DescTextbox").value;
		this.props.parent.setState({editingEnabled : false});
	},
	nameChange: function(event) {
		this.setState({Name: event.target.value});
	},
	descChange: function(event) {
		this.setState({Description: event.target.value});
	},
	goBack: function() {
		this.props.parent.setState({editingEnabled : false});
	},
	render: function() {
		return (
			<div className='container' id='sidebar'>
				<form>
					<div id="NameDiv">
						<input id="NameTextbox" type="text" placeholder="Map Name" defaultValue={this.props.mapNode.mapName}/>
					</div>
					<div id="DescDiv">
						<textarea id="DescTextbox" placeholder="Description" defaultValue={this.props.mapNode.mapInfo}/>
					</div>
				</form>
				<div id="createButton">
					<input type="submit" value="Confirm" onClick={this.finishEditing}/>
				</div>
				<div id="backButton">
					<button onClick={this.goBack}>Back</button>
				</div>
			</div>
		);
	}
});

var World = React.createClass({
	getInitialState: function() {
		return {
			editingEnabled: false
		}
	},
	changeLoc: function(loc) {
		this.props.currentMap = loc;
	},
	addNewLoc: function() {
		console.log("+ button pressed");
		this.props.mapToEdit = new MapNode(this.props.currentMap);
		this.props.currentMap.childMaps.push(this.props.mapToEdit);
		this.setState({editingEnabled : true});
	},
	editMap: function() {
		console.log("Edit button pressed");
		this.props.mapToEdit = this.props.currentMap;
		this.setState({editingEnabled : true});
	},
	render: function() {
		this.props.currentMap = this.props.currentMap || this.props.rootMap;
		return (
			<div className='container'>
				<div className='container' id='mapImageContainer'>
					<MapImage mapNode={this.props.currentMap} parent={this} />
				</div>
				<div className='container' id='sidebarContainer'>
					{this.state.editingEnabled ? 
							<EditSidebar mapToEdit={this.props.mapToEdit} mapNode={this.props.currentMap} parent={this}/> : 
							<DefaultSidebar mapNode={this.props.currentMap} parent={this} />}
				</div>
			</div>
		);
	}
});

window.addEventListener("load", start, false);

		</script>
	</head>
	<body ondragstart='return false;' ondrop='return false;' />
</html>
