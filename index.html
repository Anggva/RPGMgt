<!DOCTYPE html>
<html>
	<head>
		<link rel='stylesheet' type='text/css' href='style.css'>
		<link rel='stylesheet' type='text/css' href='build/perfect-scrollbar.css'>
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="http://code.jquery.com/ui/1.11.0/jquery-ui.min.js"></script>
		<script src="build/perfect-scrollbar.js"></script>
		<script src='build/JSXTransformer.js'></script>		
		<script src='build/react.js'></script>
		<script type='text/jsx'>

function MapNode(mapName,imageSrc,mapInfo) {
	this.mapName = mapName,
	this.imageSrc = imageSrc,
	this.mapInfo = mapInfo,
	this.childMaps = [],
	this.addChild = function(newChild) {
		// prompt for new map info, including prompting for location
		childMaps.push(newChild);
	}
};

var MapImage = React.createClass({
	getInitialState: function() {
		return {
			zoomFactor : 1.0
		}
	},
	getDefaultProps: function() {
		return {
		}
	},
	componentWillMount: function() {

	},
	componentDidMount: function() {
		//var mapImageElement = document.getElementById('mapImage');
		//mapImageElement.addEventListener('dblclick', resetImage);
		var wDif = $('#mapImageContainer').width() - $('#mapImage').width();
		var hDif = $('#mapImageContainer').height() - $('#mapImage').height();
		if(wDif > 0 || hDif > 0) {
			if(hDif > wDif) {
				$('#mapImage').css('height','100%');
			} else {
				$('#mapImage').css('width','100%');
			}
		}
		Ps.initialize(document.getElementById('mapImageContainer'), {
			//See https://github.com/noraesae/perfect-scrollbar for info on how to use this.
		});
		var curDown, curYPos, curXPos;
		$('#mapImageContainer').mousemove(function(e){
			if(curDown === true){
				console.log('Scrolling');
				$('#mapImageContainer').scrollTop(
					$('#mapImageContainer').scrollTop() + (curYPos - e.pageY)
				); 
				$('#mapImageContainer').scrollLeft(
					$('#mapImageContainer').scrollLeft() + (curXPos - e.pageX)
				);
			}
		});
		$('#mapImageContainer').mousedown(function(e){
			if(e.which == 2) {
				curDown = true;
				curYPos = e.pageY;
				curXPos = e.pageX;
			}
		});
		$('#mapImageContainer').mouseup(function(){
			curDown = false;
		});
	},
	render: function() {
		return(
			<img id='mapImage' src={this.props.mapNode.imageSrc}>
				{this.props.mapNode.childMaps.map(function(childMap){
					return <div className='mapLoc' onclick='gotoLoc(childMap)' style={childMap.loc} />;
				})}
			</img>
		);
	}
});

var Sidebar = React.createClass({
	render: function() {
		return(
			<div className='container' id='sidebar'>
				<div id='title'><div id='t'>
					<h1>{this.props.mapNode.mapName}</h1>
				</div></div>
				<div id='mapInfo'>
					<p>{this.props.mapNode.mapInfo}</p>
				</div>
				<div id='options'>
				</div>
				<div id='bottomBar'></div>
			</div>
		);
	}
});

var World = React.createClass({
	getInitialState: function() {
		return {
			editingEnabled: false,
			currentlyAddingMap: false,
			rootMap: new MapNode('test map','testImage.jpg','asdfasdf')
		}
	},
	componentDidLoad: function() {
		this.setState({
			rootMap: $.getJSON("mapData.json")
		})
	},
	changeLoc: function(loc) {
		this.props.currentMap = loc;
	},
	render: function() {
		this.props.currentMap = this.props.currentMap || this.state.rootMap;
		return(
			<div className='container'>
				<div className='container' id='mapImageContainer'>
					<MapImage mapNode={this.props.currentMap} parent={this} />
				</div>
				<div className='container' id='sidebarContainer'>
					<Sidebar mapNode={this.props.currentMap} parent={this} />
				</div>
			</div>
		);
	}
});

React.render(<World />, document.body);

		</script>
	</head>
	<body ondragstart='return false;' ondrop='return false;' />
</html>